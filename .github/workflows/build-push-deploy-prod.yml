name: DynamicNFTs prod pipe

on:
    push:
        branches:
          - "master"

env:
    ENVIRONMENT: prod
    PROJECT_NAME: dynamic-nfts

jobs:
    deploy-infra:
        runs-on: ubuntu-22.04

        steps:
            - uses: actions/setup-node@v2
              with:
                  node-version: "16"

            - name: Checkout repository
              uses: actions/checkout@v2
              with:
                  ref: ${{ github.ref_name }}
                  path: dynamic-nfts

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: eu-west-3

            - uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.2.2

            - name: Terraform Init
              run: |
                  terraform -chdir=dynamic-nfts/.deployment init -backend-config="key=${{ env.PROJECT_NAME }}/prod"

            - name: Terraform apply
              env:
                TF_VAR_project_name: ${{ env.PROJECT_NAME }}
                TF_VAR_environment: ${{ env.ENVIRONMENT }}
              run: terraform -chdir=dynamic-nfts/.deployment apply -var-file="variables.tfvars" -auto-approve

            - run: | 
                terraform -chdir=dynamic-nfts/.deployment output aws_ecr_repository-ipfs-name > /tmp/aws_ecr_repository-ipfs-name 
                terraform -chdir=dynamic-nfts/.deployment output aws_ecr_repository-frontend-name > /tmp/aws_ecr_repository-frontend-name
                grep -o '".*"' /tmp/aws_ecr_repository-ipfs-name | sed 's/"//g' > /tmp/aws_ecr_repository-ipfs-name
                grep -o '".*"' /tmp/aws_ecr_repository-frontend-name | sed 's/"//g' > /tmp/aws_ecr_repository-frontend-name

            - uses: actions/upload-artifact@v2
              with:
                name: aws_ecr_repository-ipfs-name
                path: /tmp/aws_ecr_repository-ipfs-name 

            - uses: actions/upload-artifact@v2
              with:
                name: aws_ecr_repository-frontend-name
                path: /tmp/aws_ecr_repository-frontend-name                 

    build-ipfs:
        runs-on: ubuntu-22.04

        steps:
            # - uses: actions/setup-node@v2
            #   with:
            #       node-version: "16"

            - name: Checkout repository
              uses: actions/checkout@v2
              with:
                  ref: ${{ github.ref_name }}
                  path: ${{ env.PROJECT_NAME }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: eu-west-3

            - name: Build docker image
              run: |
                cd ${{ env.PROJECT_NAME }}
                docker build -t ${{ inputs.ecr-registry }}/${{ inputs.ecr-repository }}:${{ inputs.image-tag }} .

            - name: Terraform Init
              run: |
                  terraform -chdir=dynamic-nfts/.deployment init -backend-config="key=${{ env.PROJECT_NAME }}/prod"

            - name: Terraform apply
              env:
                TF_VAR_project_name: ${{ env.PROJECT_NAME }}
                TF_VAR_environment: ${{ env.ENVIRONMENT }}
              run: terraform -chdir=dynamic-nfts/.deployment apply -var-file="variables.tfvars" -auto-approve              

              


