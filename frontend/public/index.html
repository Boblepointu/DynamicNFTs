<html>
    <head>
        <title>
            Hello world
        </title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    </head>
    <body>
        Hello world
        <div id="error">
            You don't have metamask on your browser ! Install it before continuing.
        </div>
        <div id="body">
            <button type="button" id="mintExclusive" value="Mint in exclusive mode">Mint in exclusive mode</button>
            <input type="text" id="mintExclusiveTokenId" /><br />
            <button type="button" id="mintNonExclusive" value="Mint in non exclusive mode">Mint in non exclusive mode</button><br />
            <div id="tokenDisplay">
                <label>Contract address : </label><span id="contractAddress"></span>
                <label>Token id : </label><span id="tokenId"></span>
                <label>Token name : </label><span id="tokenName"></span>
                <label>Token description : </label><span id="tokenDescription"></span>
                <img id="tokenImage" src="" />
            </div>
        </div>

        <script>
            let web3
            let account
            let abi
            let BACKEND_HOST
            let IPFS_HOST
            let WEATHER_CONTRACT_ADDRESS
            let DIAMOND_CONTRACT_ADDRESS
            let EXCLUSIVE_CONTRACT_ADDRESS
            let NETWORK_ID
            let ipfsGatewayUrl

            const addTokenToMetamask = async (tokenId) => {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721', // Initially only supports ERC20, but eventually more!
                        options: {
                            address: DIAMOND_CONTRACT_ADDRESS, // The address that the token is at.
                            symbol: 'WTH', // A ticker symbol or shorthand, up to 5 chars.
                            tokenId
                        },
                    },
                })
            }

            const displayMintedNft = async tokenUri => {
                document.getElementById("error").hidden = true
                const CID = tokenUri.replace('ipfs://', '')
                const tokenMetadata = await (await fetch(`${ipfsGatewayUrl}${CID}`)).json()
                const tokenImage = `${ipfsGatewayUrl}${tokenMetadata.image.replace('ipfs://', '')}`
                document.getElementById("contractAddress").innerHTML = DIAMOND_CONTRACT_ADDRESS
                document.getElementById("tokenId").innerHTML = tokenId
                document.getElementById("tokenName").innerHTML = tokenMetadata.name
                document.getElementById("tokenDescription").innerHTML = tokenMetadata.description
                document.getElementById("tokenImage").setAttribute(src, tokenImage)
                document.getElementById("tokenDisplay").hidden = false
            }

            const mintExclusive = async () => {
                const exclusiveTokenId = document.getElementById("mintExclusiveTokenId").value
                document.getElementById("error").hidden = true
                if(exclusiveTokenId === ''){
                    document.getElementById("error").innerHTML = "Please specify before the tokenId you own in the exclusive collection !"
                    document.getElementById("error").hidden = false
                    return
                }

                const ERC721Contract = new web3.eth.Contract(abi, DIAMOND_CONTRACT_ADDRESS)
                await ERC721Contract.methods.payableExclusiveMint(exclusiveTokenId, accounts[0]).send({ from: account, value: 500000000000000 })
                console.log(`Minted a new token in exclusive mode ! Adding to Metamask wallet !`)
                const tokenId = await ERC721Contract.methods.totalSupply()
                const tokenUri = await ERC721Contract.methods.tokenURI()
                await displayMintedNft(tokenUri)
            }

            const mintNonExclusive = async () => {
                const ERC721Contract = new web3.eth.Contract(abi, DIAMOND_CONTRACT_ADDRESS)
                await ERC721Contract.methods.payableNonExclusiveMint(account).send({ from: account, value: 1000000000000000 })
                console.log(`Minted a new token in non exclusive mode ! Adding to Metamask wallet !`)
                const tokenId = await ERC721Contract.methods.totalSupply()
                const tokenUri = await ERC721Contract.methods.tokenURI()
                await displayMintedNft(tokenUri)
            }

            (async () => {
                document.getElementById("body").hidden = true
                document.getElementById("tokenDisplay").hidden = true
                document.getElementById("error").hidden = true

                if (typeof window.ethereum === 'undefined') {
                    console.log('MetaMask is not installed !')
                    document.getElementById("body").hidden = true
                    document.getElementById("error").hidden = false
                    return
                }

                document.getElementById("body").hidden = false
                document.getElementById("error").hidden = true

                account = (await window.ethereum.request({ method: 'eth_requestAccounts' }))[0]

                web3 = new Web3(window.web3.currentProvider)
                
                const runTimeVars = await (await fetch('/runTimeVars')).json()

                BACKEND_HOST = runTimeVars.BACKEND_HOST
                IPFS_HOST = runTimeVars.IPFS_HOST
                WEATHER_CONTRACT_ADDRESS = runTimeVars.WEATHER_CONTRACT_ADDRESS
                DIAMOND_CONTRACT_ADDRESSs = runTimeVars.DIAMOND_CONTRACT_ADDRESSs
                EXCLUSIVE_CONTRACT_ADDRESS = runTimeVars.EXCLUSIVE_CONTRACT_ADDRESS
                NETWORK_ID = runTimeVars.NETWORK_ID

                ipfsGatewayUrl = `https://${IPFS_HOST}/ipfs/`

                console.log(`Fetched run time vars !`)

                abi = await (await fetch('/abi.json')).json()

                console.log(`Fetched ABI !`)

                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${NETWORK_ID}`}]
                })

                document.getElementById("mintExclusive").onclick = mintExclusive
                document.getElementById("mintNonExclusive").onclick = mintNonExclusive
            })()
        </script>        
    </body>
</html>