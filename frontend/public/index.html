<html>
    <head>
        <title>
            Hello world
        </title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    </head>
    <body>
        Hello world
        <div id="error">
            You don't have metamask on your browser ! Install it before continuing.
        </div>
        <div id="body">
            
        </div>

        <script>
            let account
            let abi
            let BACKEND_HOST
            let WEATHER_CONTRACT_ADDRESS
            let DIAMOND_CONTRACT_ADDRESS
            let EXCLUSIVE_CONTRACT_ADDRESS
            let NETWORK_ID

            const addTokenToMetamask = async (tokenId) => {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721', // Initially only supports ERC20, but eventually more!
                        options: {
                            address: DIAMOND_CONTRACT_ADDRESS, // The address that the token is at.
                            symbol: 'WTH', // A ticker symbol or shorthand, up to 5 chars.
                            tokenId
                        },
                    },
                })
            }

            const mintExclusive = async tokenIdInExclusiveContract => {
                const ERC721Contract = new web3.eth.Contract(abi, DIAMOND_CONTRACT_ADDRESS)
                await ERC721Contract.methods.payableExclusiveMint(tokenIdInExclusiveContract, accounts[0]).send({ from: accounts[0], value: 500000000000000 })
                console.log(`Minted a new token in exclusive mode ! Adding to Metamask wallet !`)
            }

            const mintNonExclusive = async () => {
                const ERC721Contract = new web3.eth.Contract(abi, DIAMOND_CONTRACT_ADDRESS)
                await ERC721Contract.methods.payableNonExclusiveMint(accounts[0]).send({ from: accounts[0], value: 1000000000000000 })
                console.log(`Minted a new token in non exclusive mode ! Adding to Metamask wallet !`)
            }


            (async () => {
                document.getElementById("body").hidden = true
                document.getElementById("error").hidden = true

                if (typeof window.ethereum === 'undefined') {
                    console.log('MetaMask is not installed !')
                    document.getElementById("body").hidden = true
                    document.getElementById("error").hidden = false
                    return
                }

                document.getElementById("body").hidden = false
                document.getElementById("error").hidden = true

                account = (await window.ethereum.request({ method: 'eth_requestAccounts' }))[0]

                const web3 = new Web3(window.web3.currentProvider)
                
                const runTimeVars = await (await fetch('/runTimeVars')).json()

                BACKEND_HOST = runTimeVars.BACKEND_HOST
                WEATHER_CONTRACT_ADDRESS = runTimeVars.WEATHER_CONTRACT_ADDRESS
                DIAMOND_CONTRACT_ADDRESSs = runTimeVars.DIAMOND_CONTRACT_ADDRESSs
                EXCLUSIVE_CONTRACT_ADDRESS = runTimeVars.EXCLUSIVE_CONTRACT_ADDRESS
                NETWORK_ID = runTimeVars.NETWORK_ID

                console.log(`Fetched run time vars !`)

                const abi = await (await fetch('/abi.json')).json()

                console.log(`Fetched ABI !`)

                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${NETWORK_ID}`}]
                })

                const ERC721Contract = new web3.eth.Contract(abi, DIAMOND_CONTRACT_ADDRESS)
                console.log(ERC721Contract)
            })()
        </script>        
    </body>
</html>